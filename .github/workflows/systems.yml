name: Systems
on:
  #TODO: Remove
  push:
  schedule:
    # Sunday 1AM
    - cron: '0 1 * * 0' 

concurrency:
  group: perlmutter-omega_h

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        machine: ["Perlmutter", "Frontier"]

    steps:

    - name: checkout omega_h
      uses: actions/checkout@v4
      with:
        path: omega_h

    - name: setup python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: install packing
      run: sudo apt install python3-packaging

    - name: install globus
      run: |
          python -m ensurepip --upgrade --user
          python -m pip install globus-compute-endpoint

    - name: set endpoint
      run: |
          if ${{matrix.machine}} == "Perlmutter"; then TARGET_ENDPOINT=123; else TARGET_ENDPOINT=456; fi
          echo $TARGET_ENDPOINT

    - run: exit 1

    - name: use globus
      working-directory: omega_h/.github/workflows
      env:
        GLOBUS_ID: ${{ secrets.GLOBUS_COMPUTE_ID }}
        GLOBUS_SECRET: ${{ secrets.GLOBUS_COMPUTE_SECRET }}
      run: |
        export FUNCX_SDK_CLIENT_ID="$GLOBUS_ID"
        export FUNCX_SDK_CLIENT_SECRET="$GLOBUS_SECRET"
        python globus-compute.py ${{ github.sha }} $TARGET_ENDPOINT

    - name: print build log
      working-directory: omega_h/.github/workflows
      run: cat omega_h-test-result/Build.log

    - name: print test summary
      working-directory: omega_h/.github/workflows
      run: cat omega_h-test-result/TestSummary.log

    - name: print test log
      working-directory: omega_h/.github/workflows
      run: cat omega_h-test-result/LastTest.log

    - name: check failed test
      working-directory: omega_h/.github/workflows
      run: if grep "Failed" omega_h-test-result/TestSummary.log; then return 1; fi

    